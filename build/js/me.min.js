(function(){function c(d,a,l){var g=$("<div></div>").addClass("control-panel"),e=$("<input type='button' value='\u30b9\u30c6\u30c3\u30d7\u5b9f\u884c' />");e.click(function(){a.step()});g.append(e);if(l.SHOW_RUN_BUTTON){var f=$("<input type='button' value='\u5b9f\u884c\uff08"+l.RUN_HZ+"Hz\uff09' />");f.click(function(){k?(k=!1,a.stop(),f.attr("value","\u5b9f\u884c\uff08"+l.RUN_HZ+"Hz\uff09")):(k=!0,a.run(1E3/l.RUN_HZ),f.attr("value","\u505c\u6b62"))});g.append(f);a.addOnCompleteListener(function(){k&&
(k=!1,f.attr("value","\u5b9f\u884c\uff08"+l.RUN_HZ+"Hz\uff09"))});a.addOnResetListener(function(){k&&(k=!1,a.stop(),f.attr("value","\u5b9f\u884c\uff08"+l.RUN_HZ+"Hz\uff09"))});a.regs.addListener("eip",function(d){k&&-1!==w.indexOf(d)&&(k=!1,a.stop(),f.attr("value","\u5b9f\u884c\uff08"+l.RUN_HZ+"Hz\uff09"))})}e=$("<input type='button' value='\u30ea\u30bb\u30c3\u30c8' />");e.click(function(){a.reset()});g.append(e);d.append(g)}function b(d,a,l){var f=$("<div></div>").addClass("registers-panel"),g=$("<div></div>").css("display",
"inline-block");f.append(g);var e=$("<fieldset><legend>\u30ec\u30b8\u30b9\u30bf</legend></fieldset>");g.append(e);l.DISPLAY_REGS.forEach(function(d){var l=$("<div></div>").addClass("register");l.html([d.toUpperCase(),": "].join(""));var f=$("<span></span>").addClass("reg-"+d).text("00000000");l.append(f);e.append(l);a.regs.addListener(d,function(d){f.text(p(d,4));f.addClass("changed-value")});a.addOnClockListener(function(){f.removeClass("changed-value")});a.addOnResetListener(function(){f.removeClass("changed-value")})});
l.DISPLAY_FLAGS.forEach(function(d){var f=$("<div></div>").addClass("register");f.html([d.toUpperCase(),": "].join(""));var l=$("<span></span>").addClass("reg-"+d).text("OFF");f.append(l);e.append(f);a.regs.addListener(d,function(d){d?l.text("ON"):l.text("OFF");l.addClass("changed-value")});a.addOnClockListener(function(){l.removeClass("changed-value")});a.addOnResetListener(function(){l.removeClass("changed-value")})});d.append(f)}function a(a,f,l){var e=$("<fieldset><legend>.TEXT</legend></fieldset>").addClass("text-section"),
g=$("<div></div>").addClass("text-section-div");e.append(g);var b=$("<table></table>");b.append("<tr>"+(l.SHOW_BREAKPOINT?"<th></th>":"")+(l.SHOW_TEXT_LABEL?"<th>\u30e9\u30d9\u30eb</th>":"")+"<th>\u30a2\u30c9\u30ec\u30b9</th>"+(l.SHOW_BYTES?"<th>\u30c7\u30fc\u30bf</th>":"")+"<th>\u547d\u4ee4</th><th>\u5f15\u6570\uff11</th><th>\u5f15\u6570\uff12</th><th>\u30b3\u30e1\u30f3\u30c8</th></tr>");var m=7;l.SHOW_TEXT_LABEL||m--;l.SHOW_BYTES||m--;f.instructions.forEach(function(f){var a,e=f.err();if(f.isDefun)a=
$(["<tr><td colspan='",m,"' style='border-top: 2px solid #000; font-weight: bold;'>",f.defun,"</td></tr>"].join(""));else{a=h(f,0);var g=h(f,1),c=[];c.push("<tr>");l.SHOW_BREAKPOINT&&c.push("<td><input type='checkbox'></input></td>");l.SHOW_TEXT_LABEL&&(c.push("<td class='ts-label'>"),c.push(f.label()),c.push("</td>"));c.push("<td>");0===f.bytes().length?c.push(""):c.push(p(f.addr(),2));l.SHOW_BYTES&&(c.push("</td><td>"),c.push(d(f.bytes())));c.push("</td><td class='ts-op'>");c.push(f.op());c.push("</td><td>");
c.push(a);c.push("</td><td>");c.push(g);c.push("</td><td>");c.push(e?e:f.comment());c.push("</td></tr>");a=$(c.join(""))}e?a.addClass("error"):a.addClass("function-"+f.funcId);b.append(a);f.$row=a});g.append(b);a.append(e);n(f);b.find("input[type=checkbox]").click(function(){w=[];b.find("input[type=checkbox]").each(function(d){this.checked&&(d=f.instructions[d].addr())&&w.push(d)})})}function n(d){d.regs.addListener("eip",function(f,a){var e=d.getInstruction(a);e&&e.$row.removeClass("activated");
(e=d.getInstruction(f))&&e.$row.addClass("activated")})}function h(d,f){var a=d.args()[f];if(!a)return"\u3000";var e=a.type;return e===me.instruction.ARG_REG8||e===me.instruction.ARG_REG16||e===me.instruction.ARG_REG32?["<span class='ts-reg'>",a.src(),"</span>"].join(""):e===me.instruction.ARG_SREG?["<span class='ts-reg'>",a.src(),"</span>"].join(""):e===me.instruction.ARG_RM8||e===me.instruction.ARG_RM16||e===me.instruction.ARG_RM32?0===a.disp()?["[<span class='ts-reg'>",a.regName,"</span>]"].join(""):
0<a.disp()?["[<span class='ts-reg'>",a.regName,"</span> + <span class='ts-im'>",a.disp(),"</span>]"].join(""):["[<span class='ts-reg'>",a.regName,"</span> - <span class='ts-im'>",-a.disp(),"</span>]"].join(""):e===me.instruction.ARG_IMM8||e===me.instruction.ARG_IMM16||e===me.instruction.ARG_IMM32?["<span class='ts-im'>",a.src(),"</span>"].join(""):e===me.instruction.ARG_LABEL?["<span class='ts-label'>",a.src(),"</span>"].join(""):e===me.instruction.ARG_STR?["<span class='ts-string'>",a.src(),"</span>"].join(""):
e===me.instruction.ARG_ARR?["<span class='ts-im'>",a.src(),"</span>"].join(""):"\u3000"}function q(d,a,e){e.PANEL_VERTICAL&&d.append($("<div></div>"));var c=$("<fieldset><legend>\u30b9\u30bf\u30c3\u30af</legend></fieldset>").addClass("stack-section"),b=$("<div></div>").addClass("stack-section-div");c.append(b);var n=$("<table></table>");b.append(n);n.append("<tr>"+(e.SHOW_STACK_ESP?"<th>ESP</th>":"")+(e.SHOW_STACK_EBP?"<th>EBP</th>":"")+"<th>\u30a2\u30c9\u30ec\u30b9</th><th>\u30c7\u30fc\u30bf</th><th>\u30b3\u30e1\u30f3\u30c8</th></tr>");
for(var b=e.STACK_START,q={},k=b-e.DISPLAY_STACK_BYTES;k<=b;k+=4){var t=a.memory.read32(k);t||(t=0);var h=[];h.push("<tr>");e.SHOW_STACK_ESP&&(h.push("<td class='stack-esp'>"),h.push(k===b?"=>":""),h.push("</td>"));e.SHOW_STACK_EBP&&(h.push("<td class='stack-ebp'>"),h.push(""),h.push("</td>"));h.push("<td>");h.push(p(k,2));h.push("</td><td class='stack-data'>");h.push(p(t,4));h.push("</td><td class='stack-comment'>");h.push("");h.push("</td></tr>");t=$(h.join(""));n.append(t);q[k]=t}d.append(c);m(a,
q);f(a,q);g(a,q)}function m(d,a){t.forEach(function(e){d.regs.addListener(e,function(d,f){var g=a[f];g&&g.find(".stack-"+e).text("");(g=a[d])&&g.find(".stack-"+e).text("=>")})})}function f(d,a){d.memory.addOnChangeListener(function(e,f){var g=a[e];if(g){g.find(".stack-data").text(p(f,4)).addClass("changed-value");var b=d.memory.getAttribute(e);b&&(void 0!==b.funcId&&g.addClass("function-"+b.funcId),b.comment&&g.find(".stack-comment").text(b.comment))}});d.addOnClockListener(function(){for(var d in a)a[d].find(".stack-data").removeClass("changed-value")})}
function g(d,a){d.addOnResetListener(function(){for(var d in a){var f=a[d];f.removeClass(e);f.find(".stack-data").text(p(0,4)).removeClass("changed-value");f.find(".stack-comment").text("")}})}function e(d,a){return(a.match(/(^|\s)function-\S+/g)||[]).join(" ")}function p(d,a){var e=d.toString(16).toUpperCase(),f=2*a;if(e.length<f){for(var g=[],b=0;b<f-e.length;b++)g.push("0");g.push(e);e=g.join("")}return e}function d(d){if(!d||0===d.length)return"";for(var a=[],e=0;e<d.length;e++){var f=d[e];15>=
f?a.push("0"+f.toString(16)):a.push(f.toString(16));4===e%5&&a.push("<br/>");if(8===e){a.push("\u2026");break}}return a.join(" ").toUpperCase()}window.Emulator=function(d,e,f){f=me.mergeDict(r,f);c(d,e,f);f.SHOW_REGISTERS&&b(d,e,f);a(d,e,f);f.SHOW_STACK&&q(d,e,f);e.reset();f.PLUGINS.forEach(function(a){a(d,e,f)})};var t=["ebp","esp"],r={DISPLAY_REGS:"eax ecx edx ebx ebp esp eip".split(" "),DISPLAY_FLAGS:["sign","zero","carry"],STACK_START:32768,DISPLAY_STACK_BYTES:32,PANEL_VERTICAL:!1,RUN_HZ:1,SHOW_STACK:!0,
SHOW_BREAKPOINT:!1,SHOW_BYTES:!1,SHOW_REGISTERS:!0,SHOW_TEXT_LABEL:!0,SHOW_STACK_ESP:!0,SHOW_STACK_EBP:!0,SHOW_RUN_BUTTON:!0,PLUGINS:[]},k=!1,w=[]})();(function(){function c(){this.regs=me.createRegisters();this.memory=new me.Memory;me.FD&&(this.fd=new me.FD);this.onCompleteListeners=[];this.onResetListeners=[];this.onClockListeners=[];this.isRunning=!1}function b(a){var b=a.getInstruction();if(b&&!b.err()){a.notifyOnClock();var c=b.exec(a);c||(c=b.addr()+b.bytes().length);"hlt"!==b.op()&&a.regs.eip(c)}else a.stop()}window.me={Machine:c,ENTRY_FUNC:"start",TEXT_START:256,STACK_START:32768};c.prototype.reset=function(){this.regs.reset();this.memory.reset();
this.regs.esp(me.STACK_START);this.regs.eip(this.entryAddr);this.notifyOnReset()};c.prototype.run=function(a){0===arguments.length&&(a=1E3);var c=function(a){return function(){b(a)}}(this);this.isRunning=!0;this.runTimerId=setInterval(c,a)};c.prototype.step=function(){this.isRunning||b(this)};c.prototype.stop=function(){this.isRunning&&(this.isRunning=!1,clearInterval(this.runTimerId),this.runTimerId=void 0,this.notifyOnComplete())};c.prototype.setInstructions=function(a,b,c){this.labels=2<=arguments.length?
me.link(a,b,c):me.link(a,me.TEXT_START,c);this.instructions=a;if(2<=arguments.length)this.entryAddr=b;else{var q=this.labels[me.ENTRY_FUNC];this.entryAddr=q?q.addr():me.TEXT_START}var m={};a.forEach(function(a){m[a.addr()]=a});this.addr2inst=m};c.prototype.getInstruction=function(a){0===arguments.length&&(a=this.regs.eip());return this.addr2inst[a]};c.prototype.getLabelAddr=function(a){if(a=this.labels[a])return a.addr()};c.prototype.addOnCompleteListener=function(a){this.onCompleteListeners.push(a)};
c.prototype.notifyOnComplete=function(){this.onCompleteListeners.forEach(function(a){a()})};c.prototype.addOnResetListener=function(a){this.onResetListeners.push(a)};c.prototype.notifyOnReset=function(){this.onResetListeners.forEach(function(a){a()})};c.prototype.addOnClockListener=function(a){this.onClockListeners.push(a)};c.prototype.notifyOnClock=function(){this.onClockListeners.forEach(function(a){a()})};c.prototype.pop=function(){var a=this.regs.esp,b=this.memory.read32(a());a(a()+4);return b};
c.prototype.push=function(a,b){var c=this.regs.esp;c(c()-4);b&&this.memory.setAttribute(c(),b);this.memory.write32(c(),a)}})();(function(){me.mergeDict=function(c,b){var a={};b||(b={});for(var n in c)a[n]=c[n];for(n in b)a[n]=b[n];return a}})();(function(){function c(){this.readListeners=[]}me.FD=c;c.prototype.read=function(b,a,c,h){this.readListeners.forEach(function(q){q(b,a,c,h)})};c.prototype.addReadListener=function(b){this.readListeners.push(b)}})();(function(){me.createRegisters=function(){function c(){}function b(a,b,e){m[b]=[];a[b]=function(c){if(!arguments.length)return e;var d=e;e=c?!0:!1;m[b].forEach(function(a){a(c,d)});return a}}function a(a,b,e){m[b]=[];a[b]=function(c){if(!arguments.length)return e;if(c===parseInt(c)){var d=e;e=c&65535;m[b].forEach(function(a){a(c,d)})}else throw["[Register Write Error] Invalid Register ",b.toUpperCase()," Value: ",c].join("");return a}}function n(a,b,e){m[b]=[];a[b]=function(c){if(!arguments.length)return e;
if(c===parseInt(c)){var d=e;e=c&4294967295;m[b].forEach(function(a){a(c,d)})}else throw["[Register Write Error] Invalid Register ",b.toUpperCase()," Value: ",c].join("");return a}}function h(a,b){var e=a["e"+b];a[b]=function(c){if(!arguments.length)return e()&65535;if(c===parseInt(c)){var d=e()&4294901760;e(d|c&65535)}else throw["[Register Write Error] Invalid Register ",b.toUpperCase()," Value: ",c].join("");return a}}function q(a,b){var e=a["e"+b[0]+"x"],c;c="h"===b[1]?!0:!1;a[b]=function(d){if(!arguments.length)return c?
(e()&65280)>>8:e()&255;if(d===parseInt(d)){var m;c?(m=e()&4294902015,e(m|(d&255)<<8)):(m=e()&4294967040,e(m|d&255))}else throw["[Register Write Error] Invalid Register ",b.toUpperCase()," Value: ",d].join("");return a}}var m={};(function(){me.REG32_NAMES.forEach(function(a){n(c,a,0)});me.FLAG_NAMES.forEach(function(a){b(c,a,!1)});me.SEGMENT_NAMES.forEach(function(b){a(c,b,0)});me.REG16_NAMES.forEach(function(a){h(c,a)});me.REG8_NAMES.forEach(function(a){q(c,a)})})();c.toString=function(){var a=[];
me.REG32_NAMES.forEach(function(b){a.push([b,this[b]()].join(":"))});return a.join(", ")};c.addListener=function(a,b){-1!==me.REG16_NAMES.indexOf(a)&&(a="e"+a);m[a].push(b)};c.reset=function(){me.REG32_NAMES.forEach(function(a){c[a](0)});me.FLAG_NAMES.forEach(function(a){c[a](!1)});me.SEGMENT_NAMES.forEach(function(a){c[a](0)})};return c};me.REG8_NAMES="ah al ch cl dh dl bh bl".split(" ");me.REG16_NAMES="ax cx dx bx si di bp sp ip".split(" ");me.REG32_NAMES="eax ecx edx ebx esi edi ebp esp eip".split(" ");
me.SEGMENT_NAMES=["cs","ds","es","ss"];me.FLAG_NAMES=["sign","zero","carry"]})();(function(){function c(){this.bytes=[];this.onChangeListeners=[]}me.Memory=c;c.prototype.reset=function(){this.bytes=[];this.attributes=[]};c.prototype.getAttribute=function(b){return this.attributes[b]};c.prototype.setAttribute=function(b,a){this.attributes[b]=a};c.prototype.read8=function(b){this.checkAddress(b);this.checkUndefined(b,1);return this.bytes[b]};c.prototype.read16=function(b){this.checkAddress(b);this.checkUndefined(b,2);return this.bytes[b]|this.bytes[b+1]<<8};c.prototype.read32=function(b){this.checkAddress(b);
this.checkUndefined(b,4);return this.bytes[b]|this.bytes[b+1]<<8|this.bytes[b+2]<<16|this.bytes[b+3]<<24};c.prototype.write8=function(b,a){this.checkAddress(b);this.checkValue(b,a,255);var c=this.read8(b);this.bytes[b]=a&255;this.notifyOnChange(b,a,c)};c.prototype.write16=function(b,a){this.checkAddress(b);this.checkValue(b,a,65535);var c=this.read16(b);this.bytes[b]=a&255;this.bytes[b+1]=a>>8&255;this.notifyOnChange(b,a,c)};c.prototype.write32=function(b,a){this.checkAddress(b);this.checkValue(b,
a,4294967295);var c=this.read32(b);this.bytes[b]=a&255;this.bytes[b+1]=a>>8&255;this.bytes[b+2]=a>>16&255;this.bytes[b+3]=a>>24&255;this.notifyOnChange(b,a,c)};c.prototype.addOnChangeListener=function(b){this.onChangeListeners.push(b)};c.prototype.notifyOnChange=function(b,a,c){this.onChangeListeners.forEach(function(h){h(b,a,c)})};c.prototype.checkAddress=function(b){if(b!==parseInt(b)||0>b||4294967295<b)throw["[Memory Access Error] Invalid Address: ",b].join("");};c.prototype.checkUndefined=function(b,
a){for(var c=b;c<a;c++)if("undefined"===typeof this.bytes[c])throw["[Memory Read Error] attempted to read undefined value. (Address: ",c,")"].join("");};c.prototype.checkValue=function(b,a,c){if(a!==parseInt(a))throw["[Memory Write Error] Invalid Value : ",a].join("");if(0>a||a>c)throw["[Memory Write Error] value must be less than or equal to ",c.toString(16),". (Address: ",b,", Value: ",a].join("");}})();(function(){function c(){this.instructions=[];this.consts={};this.funcs=[];this.callingConvention=me.CC_CDECL}function b(b,c){var f=[];a(b,c).forEach(function(a){var e=a.op;e&&(e=e.toLowerCase());var p=!1;-1!==n.indexOf(e)&&(p=!0);for(var d=[],h=0;h<a.args.length;h++){var r=a.args[h];r in b.consts&&(d.push({i:h,src:r}),a.args[h]=""+b.consts[r])}var k=me.instruction.create(a.op,a.args,p);"equ"===e&&(b.consts[a.label]=k.arg0.value(null));0!==d.length&&d.forEach(function(a){k.args()[a.i].src(a.src)});
k.src(c).label(a.label).comment(a.comment).memoryComment(a.memoryComment);f.push(k)});return f}function a(a,b){for(var c=0;c<h.length;c++){var g=h[c],e=g[1];if(g=b.match(g[0]))return e(a,g)}throw"Invalid line: "+b;}me.Assembler=c;me.CC_CDECL=1;me.CC_STDCALL=2;var n=["org","equ"],h=[[/^\s*(?:([a-zA-Z_]\w*)(?::))?\s*([a-zA-Z_]\w*)\((.*)\)\s*$/,function(a,b){var c=b[2],g=[];b[3].split(",").forEach(function(a){a=String(a).replace(/^\s+|\s+$/g,"");""!==a&&g.push(a)});var e=[];g.forEach(function(a,b){var g=
["[",c,"] \u5f15\u6570",b+1].join("");e.push({label:"",op:"push",args:[a],comment:"",memoryComment:g})});e.reverse();var p=[c,"(",b[3],")"].join("");e.push({label:"",op:"call",args:[c],comment:p,memoryComment:""});a.callingConvention===me.CC_CDECL&&0!==g.length&&e.push({label:"",op:"add",args:["esp",""+4*g.length],comment:"\u5f15\u6570\u306e\u5f8c\u51e6\u7406",memoryComment:""});b[1]&&(e[0].label=b[1]);return e}],[/^\s*(?:([a-zA-Z_]\w*)(?::))?\s*(db)\s*([\da-fx,]+)\s*(?:(?:;)([^#]*))?/i,function(a,
b){var c={},g=[];b[1]&&(c.label=b[1]);b[2]&&(c.op=b[2]);b[3]&&g.push(b[3]);b[4]&&(c.comment=b[4]);c.args=g;return[c]}],[/^\s*(?:([a-zA-Z_]\w*)(?::))?\s*([a-zA-Z]+)?\s*((?:[\w\[\]\-\$]+|(?:".*")))?\s*(?:,\s*([\w\[\]]+))?\s*(?:(?:;)([^#]*))?\s*(?:(?:#)(.*))?$/i,function(a,b){var c={},g=[];b[1]&&(c.label=b[1]);b[2]&&(c.op=b[2]);b[3]&&g.push(b[3]);b[4]&&g.push(b[4]);b[5]&&(c.comment=b[5]);b[6]&&(c.memoryComment=b[6]);c.args=g;return[c]}]];c.prototype.assemble=function(a){var c=this,f=[];(-1!==a.indexOf("\r")?
a.split("\r\n"):a.split("\n")).forEach(function(a){b(c,a).forEach(function(a){c.instructions.push(a);f.push(a)})});return f}})();(function(){me.link=function(c,b,a){var n=b,h={};c.forEach(function(a){if("org"===a.op().toLowerCase())n=a.arg0.value(null);else{a.addr(n);n+=a.bytes().length;var b=a.label();b&&(h[b]?a.err("Label Name Conflict"):h[b]=a)}});c.forEach(function(b){b.args().forEach(function(c){if(c.type===me.instruction.ARG_LABEL){var f=h[c.label];f?c.link(f.addr()):a||b.err("Not Found Label: "+c.label)}})});return h}})();(function(){function c(a,b){b.forEach(function(b){if("r/m"===b.type){var c=a.form.match(M);if(!c)throw"not found r/m(8|16|32)";b.type="r/m8"===c[1]?"r/m8":"r/m16"===c[1]?"r/m16":"r/m32"}})}function b(a,b,c){b=a.bytes.slice(0);if("resb imm32"===a.form)for(var d=0;d<c[0].value(null);d++)b.push(0);else if("db str"===a.form){b=c[0].str;for(var d=[],e=0;e<b.length;e++)d.push(b.charCodeAt(e));b=d}else"db arr"===a.form?b=c[0].arr.slice(0):"db imm8"===a.form?b=z(c[0].value(null),1):"dw imm16"===a.form?b=
z(c[0].value(null),2):"dd imm32"===a.form&&(b=z(c[0].value(null),4));a.opcodeArr[0].match(A)&&(b[0]+=N[c[0].regName]);return b}function a(a){if(!a)return{};var b=a.toLowerCase();if(-1!==O.indexOf(b))return(new h("sreg",b)).src(a);if(-1!==I.indexOf(b))return(new h("r8",b)).src(a);if(-1!==J.indexOf(b))return(new h("r16",b)).src(a);if(-1!==K.indexOf(b))return(new h("r32",b)).src(a);if(0===b.indexOf("var_"))return(new q("ebp",0)).varName(a.substr(4)).src("[ebp-@]");if(0===b.indexOf("arg_"))return(new q("ebp",
0)).argName(a.substr(4)).src("[ebp+@]");if(b=a.match(P))return(new f(b[1])).src(a);if(b=a.match(Q))return(new m(a)).src(a);if(b=a.match(R))return(new q("si",0)).src(a);if(b=n(a))return(new g(b.val,b.radix)).src(a);if(b=a.match(S)){for(var c=a.split(","),d=[],p=0;p<c.length;p++){b=n(c[p]);if(!b)return[];d.push(b.val)}return(new e(d)).src(a)}return{}}function n(a){var b=a.match(T);return b?(a=parseInt(a,10),{val:a,radix:10}):(b=a.match(U))?(a=parseInt(b[1],16),{val:a,radix:16}):(b=a.match(V))?(a=parseInt(b[1],
2),{val:a,radix:2}):null}function h(a,b){this.type=a;this.regName=b}function q(a,b){this.type="r/m";this.regName=a;this.dispVal=b}function m(a){this.type="lbl";this.label=a}function f(a){this.type="str";this.str=a}function g(a,b){this.type="imm32";this.val=a;this.radix=b}function e(a){this.type="arr";this.arr=a}function p(a){if(0===arguments.length)return this.srcStr;this.srcStr=a;return this}function d(a){var b;var c=a.form.match(W);if(c){b=c[1].toLowerCase();var d=c[2]?c[2].toLowerCase():"",c=c[3]?
c[3].toLowerCase():"",e=[];""!==d&&e.push(d);""!==c&&e.push(c);b=[b].concat(e).join("_")}else b=null;if(!b)throw"invalid form";a.opcodeArr=a.opcode.split(" ");a.bytes=t(a.opcodeArr);if(d=a.opcode.match(L))a.opcodeExt=parseInt(d[1]);y[b]=a}function t(a){var b=[];a.forEach(function(a){if(a.match(X))b.push(parseInt(a,16));else if(a.match(A))a=a.match(A),b.push(parseInt(a[1],16));else if("/r"===a)b.push(0);else if("ib"===a||"cb"===a)b=b.concat([0]);else if("iw"===a||"cw"===a)b=b.concat([0,0]);else if("id"===
a||"cd"===a)b=b.concat([0,0,0,0]);else if(a.match(L))b.push(0);else throw"invalid opcode";});return b}function r(a,b){for(var c=k(a,b),d=0;d<c.length;d++){var e=y[c[d]];if(e)return e}return null}function k(a,b){if(!a||""===a)return[];var c=[a].concat(b).map(function(){return[]});c[0]=[a];b.forEach(function(a,d){var e=d+1;if("r/m"===a.type)c[e].push("r/m8"),c[e].push("r/m16"),c[e].push("r/m32");else if("imm32"===a.type||"lbl"===a.type){var x=a.value(null);255>=x&&c[e].push("imm8");65535>=x&&c[e].push("imm16");
"lbl"===a.type&&c[e].push("imm32")}else-1===I.indexOf(a.regName)&&-1===J.indexOf(a.regName)&&-1===K.indexOf(a.regName)||c[e].push(a.regName);c[e].push(b[d].type)});var d=[];w(c).forEach(function(a){d.push(a.join("_"))});window.console.log();window.console.log(a,b);window.console.log(d);return d}function w(a){function b(a,c){for(var d,e=c.slice(1),x=!e.length,f=[],g=0;g<c[0].length;g++)d=a.slice(),d.push(c[0][g]),x?f.push(d):f=f.concat(b(d,e));return f}return b([],a)}function z(a,b){for(var c=[],d=
0;d<b;d++)c.push(a&255),a>>=8;return c}function v(){}function l(a){this.arg0.value(a,this.arg1.value(a))}function u(a){var b=this.arg0.value(a)+this.arg1.value(a);this.arg0.value(a,b)}function B(a){var b=this.arg0.value(a)-this.arg1.value(a);this.arg0.value(a,b)}function C(a){var b=this.arg0.value(a)-this.arg1.value(a);0===b?a.regs.zero(!0):a.regs.zero(!1);0>b?a.regs.carry(!0):a.regs.carry(!1)}function D(a){a.push(this.arg0.value(a),{funcId:this.funcId,comment:this.memoryComment()})}function E(a){return this.arg0.value(a)}
function F(a){if(a.regs.zero())return this.arg0.value(a)}function G(a){if(a.regs.carry())return this.arg0.value(a)}function H(a){if(!1===a.regs.carry())return this.arg0.value(a)}me.instruction={add:d,create:function(d,e,f){function g(){}function p(a,b,c){a[b]=function(b){if(!arguments.length)return c;c=b;return a}}(function(a){a.forEach(function(a){p(g,a)})})("src addr bytes label comment memoryComment err".split(" "));d||(d="");e.forEach(function(b,c){e[c]=a(b);g["arg"+c]=e[c]});if(g.isDirective=
f)g.bytes([]);else if(f=r(d.toLowerCase(),e)){var k=b(f,d,e);g.bytes(k);g.exec=f.exec;g.cls=f;c(f,e)}else g.bytes([]),""!==d&&g.err("invalid instruction");g.toString=function(){return g.src()};g.op=function(){return d};g.args=function(){return e};return g},printInstructionClasses:function(){for(var a in y)window.console.log(a,y[a])},ARG_REG8:"r8",ARG_REG16:"r16",ARG_REG32:"r32",ARG_SREG:"sreg",ARG_RM8:"r/m8",ARG_RM16:"r/m16",ARG_RM32:"r/m32",ARG_MEMORY:"mem",ARG_IMM8:"imm8",ARG_IMM16:"imm16",ARG_IMM32:"imm32",
ARG_LABEL:"lbl",ARG_STR:"str",ARG_ARR:"arr"};var I="al ah ch cl dh dl bh bl".split(" "),J="ax cx dx bx sp bp si di cs ds es ss fs gs".split(" "),K="eax ecx edx ebx esp ebp esi edi".split(" "),O="cs ds es ss fs gs".split(" "),N={al:0,ax:0,eax:0,cl:1,cx:1,ecx:1,dl:2,dx:2,edx:2,bl:3,bx:3,ebx:3,ah:4,sp:4,esp:4,ch:5,bp:5,ebp:5,dh:6,si:6,esi:6,bh:7,di:7,edi:7},W=/^\s*([a-zA-Z_]\w+)\s*([^,]+)?\s*(?:,\s*(\S+))?\s*$/,M=/(r\/m(?:8|16|32))/,X=/^[\dA-F]{2}$/,A=/^([\dA-F]{2})\+r[bwd]$/,L=/\/([0-7])/,P=/^"(.*)"$/,
R=/^\[si\]$/i,Q=/^([a-zA-Z_]\w+)$/,T=/^(\d+)$/,U=/^(?:0x)([\da-f]+)$/i,V=/^(?:0b)([01]+)$/i,S=/^(?:0b|0x)?[\da-f]+(\s*,\s*(?:0b|0x)?[\da-f]+)+$/i,y={};h.prototype.value=function(a,b){if(0===arguments.length)throw"no arg";if(1===arguments.length)return a.regs[this.regName]();a.regs[this.regName](b);return this};h.prototype.src=p;q.prototype.value=function(a,b){if("r/m"===this.type)throw"type must [r/m8 or r/m16 or r/m32]";var c=a.regs[this.regName](),c=c+this.dispVal;if(0===arguments.length)throw"no arg";
if(1===arguments.length)return a.memory.read32(c);a.memory.write32(c,b);return this};q.prototype.disp=function(a){if(0===arguments.length)return this.dispVal;this.dispVal=a;return this};q.prototype.argName=function(a){if(0===arguments.length)return this.argNameStr;this.argNameStr=a;return this};q.prototype.varName=function(a){if(0===arguments.length)return this.varNameStr;this.varNameStr=a;return this};q.prototype.src=p;m.prototype.value=function(){if(0===arguments.length)throw"no arg";return this.addr?
this.addr:0};m.prototype.link=function(a){this.addr=a};m.prototype.src=p;f.prototype.value=function(){if(0===arguments.length)throw"no arg";return this.str};f.prototype.src=p;g.prototype.value=function(a,b){if(0===arguments.length)throw"no arg";if(1===arguments.length)return this.val;this.val=b;return this};g.prototype.src=p;e.prototype.value=function(a,b){if(0===arguments.length)throw"no arg";if(1===arguments.length)return this.arr;this.arr=b;return this};e.prototype.src=p;d({form:"db imm8",opcode:"ib",
exec:v});d({form:"db arr",opcode:"ib",exec:v});d({form:"db str",opcode:"ib",exec:v});d({form:"dw imm16",opcode:"iw",exec:v});d({form:"dd imm32",opcode:"id",exec:v});d({form:"resb imm32",opcode:"id",exec:v});d({form:"nop",opcode:"90",exec:v});d({form:"hlt",opcode:"F4",exec:function(a){a.stop()}});d({form:"mov sreg, r16",opcode:"8E /r",exec:l});d({form:"mov r16, r16",opcode:"89 /r",exec:l});d({form:"mov r32, r32",opcode:"89 /r",exec:l});d({form:"mov r/m32, r32",opcode:"89 /r",exec:l});d({form:"mov r8, r/m8",
opcode:"8A /r",exec:l});d({form:"mov r16, sreg",opcode:"8C /r",exec:l});d({form:"mov r16, r/m16",opcode:"8B /r",exec:l});d({form:"mov r32, r/m32",opcode:"8B /r",exec:l});d({form:"mov r8, imm8",opcode:"B0+rb ib",exec:l});d({form:"mov r16, imm16",opcode:"B8+rw iw",exec:l});d({form:"mov r32, imm32",opcode:"B8+rd id",exec:l});d({form:"mov r/m32, imm32",opcode:"C7 /0",exec:l});d({form:"add al, imm8",opcode:"04 ib",exec:u});d({form:"add ax, imm16",opcode:"05 iw",exec:u});d({form:"add eax, imm32",opcode:"05 id",
exec:u});d({form:"add r8, imm8",opcode:"80 /0 ib",exec:u});d({form:"add r16, imm8",opcode:"83 /0 ib",exec:u});d({form:"add r16, imm16",opcode:"81 /0 iw",exec:u});d({form:"add r32, imm8",opcode:"83 /0 ib",exec:u});d({form:"add r32, imm32",opcode:"81 /0 id",exec:u});d({form:"add r32, r/m32",opcode:"03 /r",exec:u});d({form:"sub eax, imm32",opcode:"2D id",exec:B});d({form:"sub esp, imm32",opcode:"81 /5 id",exec:function(a){var b=this.arg1.value(a),c=this.memoryComment().split("|");if(b/4===c.length)for(var d=
a.regs.esp,e=0;e<b/4;e++){var f=d()-4*(e+1);a.memory.setAttribute(f,{funcId:this.funcId,comment:c[e]});a.memory.write32(f,a.memory.read32(f))}b=this.arg0.value(a)-b;this.arg0.value(a,b)}});d({form:"sub r32, imm32",opcode:"81 /5 id",exec:B});d({form:"cmp r8, imm8",opcode:"80 /7 ib",exec:C});d({form:"cmp r16, imm8",opcode:"83 /7 ib",exec:C});d({form:"push r32",opcode:"50",exec:D});d({form:"push imm32",opcode:"68 id",exec:D});d({form:"pop r32",opcode:"58",exec:function(a){this.arg0.value(a,a.pop())}});
d({form:"jmp imm8",opcode:"EB cb",exec:E});d({form:"jmp imm32",opcode:"E9 cd",exec:E});d({form:"jz imm8",opcode:"74 cb",exec:F});d({form:"je imm8",opcode:"74 cb",exec:F});d({form:"jnz imm8",opcode:"75 cb",exec:function(a){if(!1===a.regs.zero())return this.arg0.value(a)}});d({form:"jb imm8",opcode:"72 cb",exec:G});d({form:"jc imm8",opcode:"72 cb",exec:G});d({form:"jbe imm8",opcode:"76 cb",exec:function(a){if(a.regs.carry()||a.regs.zero())return this.arg0.value(a)}});d({form:"ja imm8",opcode:"77 cb",
exec:function(a){if(!1===a.regs.carry()&&!1===a.regs.zero())return this.arg0.value(a)}});d({form:"jae imm8",opcode:"73 cb",exec:H});d({form:"jnc imm8",opcode:"73 cb",exec:H});d({form:"call imm32",opcode:"E8 cd",exec:function(a){var b=this.addr()+this.bytes().length,c=["[",this.arg0.label,"] call\u623b\u308a\u5148"].join("");a.push(b,{funcId:this.funcId,comment:c});return this.arg0.value(a)}});d({form:"ret",opcode:"C3",exec:function(a){return a.pop()}});d({form:"ret imm16",opcode:"C2 iw",exec:function(a){var b=
a.pop();a.regs.esp(a.regs.esp()+this.arg0.value(a));return b}});d({form:"leave",opcode:"C9",exec:function(a){a.regs.esp(a.regs.ebp());a.regs.ebp(a.pop())}});d({form:"int imm8",opcode:"CD ib",exec:function(a){if(19!==this.arg0.value(a))throw"only int 0x13";if(0===a.regs.dl()){var b=a.regs.dh(),c=a.regs.ch(),d=a.regs.cl()&31,e=a.regs.al();a.fd.read(b,c,d,e);a.regs.carry(!1);a.regs.ah(0)}}})})();(function(){function c(a,b,c){a.forEach(function(a){a.args().forEach(function(f){if(f.type===me.instruction.ARG_RM32){var g,k,h=f.argName(),m=f.varName();h?(g=b.indexOf(h),-1===g?a.err("not found argument"):(k=4*(g+1)+4,f.disp(k),f.src(["[ebp+",k,"]"].join("")),(k=a.comment())?""!==k&&(k+="  "):k="",k+=[f.src()," = \u5f15\u6570",g+1," ",h].join(""),a.comment(k))):m&&(g=c.indexOf(m),-1===g?a.err("not found variable"):(k=4*(g+1),f.disp(-k),f.src(["[ebp-",k,"]"].join("")),(k=a.comment())?""!==k&&(k+=
"  "):k="",k+=[f.src()," = \u5909\u6570",g+1," ",m].join(""),a.comment(k)))}})})}function b(b){var c=b.match(m);if(!c)throw"invalid defun";b=c[1];var f=a(c[2]),c=a(c[3]);return{name:b,args:f,vars:c}}function a(a){var b=[];if(!a)return b;a.split(",").forEach(function(a){a=String(a).replace(/^\s+|\s+$/g,"");""!==a&&b.push(a)});return b}function n(a,b,c,d){if(0===c.length&&0===d.length)return[];c=[["push ebp ; EBP\u306e\u9000\u907f # [",b,"] EBP\u9000\u907f"].join(""),"mov ebp, esp ; ESP\u306e\u9000\u907f"];
0!==d.length&&c.push(h(b,d));return a.assemble(c.join("\n"))}function h(a,b){var c=[];c.push("sub esp, ");c.push(4*b.length);c.push(" ; \u5909\u6570\u306e\u78ba\u4fdd #");b.forEach(function(b,e){0!==e&&c.push("|");c.push("[");c.push(a);c.push("] \u5909\u6570");c.push(e+1);c.push(" ");c.push(b)});return c.join("")}function q(a,b,c,d,f){if(0===b.length&&0===c.length)return a.assemble("ret");c=d.USE_LEAVE?["leave"]:["mov esp, ebp ; ESP\u306e\u5fa9\u5143","pop ebp ; EBP\u306e\u5fa9\u5143"];f===me.CC_STDCALL?
c.push("ret "+4*b.length):c.push("ret");return a.assemble(c.join("\n"))}var m=/^\s*([a-zA-Z_]\w*)\((.*)\)\s*(?:var\s+(.*))?\s*$/,f={IS_ENTRY_POINT:!1,USE_LEAVE:!0};me.Assembler.prototype.defun=function(a,e,h){e=me.mergeDict(f,e);var d=b(a);this.funcs.push(d);var m=me.instruction.create("",[]);m.isDefun=!0;m.defun=a;var r=this.callingConvention;a=r===me.CC_CDECL||r===me.CC_STDCALL?n(this,d.name,d.args,d.vars):[];h=this.assemble(h);e=e.IS_ENTRY_POINT?this.assemble("hlt"):r===me.CC_CDECL||r===me.CC_STDCALL?
q(this,d.args,d.vars,e,r):[];e=a.concat(h).concat(e);0<e.length&&e[0].label(d.name);c(e,d.args,d.vars);e=[m].concat(e);var k=this.funcs.length-1;e.forEach(function(a){a.func=d;a.funcId=k});return e}})();
